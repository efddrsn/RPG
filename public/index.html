<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delfos - Demo de Voz</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; min-height: 100dvh; display: grid; place-items: center; background: #0b1020; color: #e6e9ef; }
      .card { width: min(720px, 92vw); border: 1px solid #2a2f45; border-radius: 12px; padding: 20px; background: #0f152b; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
      .title { margin: 0 0 6px; font-size: 20px; font-weight: 600; letter-spacing: .2px; }
      .subtitle { margin: 0 0 16px; font-size: 13px; opacity: .8; }
      .row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
      .spacer { height: 10px; }
      .toggle {
        display: inline-flex; align-items: center; gap: 8px; border: 1px solid #313857; border-radius: 999px; padding: 6px 10px; background: #12193a;
      }
      .toggle input { appearance: none; width: 42px; height: 24px; background: #2b3354; border-radius: 999px; position: relative; outline: none; cursor: pointer; transition: background .2s ease; }
      .toggle input::after { content: ""; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; background: #e6e9ef; border-radius: 50%; transition: transform .2s ease; }
      .toggle input:checked { background: #7b2cff; }
      .toggle input:checked::after { transform: translateX(18px); }
      .btn { appearance: none; border: 1px solid #3a4064; background: #1a2146; color: #e6e9ef; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
      .btn:hover { background: #232a55; }
      .status { font-size: 12px; opacity: .8; }
      .widget-wrap { margin-top: 14px; border: 1px dashed #2a2f45; border-radius: 12px; padding: 12px; display: grid; place-items: center; min-height: 120px; }
    </style>
  </head>
  <body>
    <main class="card">
      <h1 class="title">Delfos — Demo de Voz</h1>
      <p class="subtitle">Use o botão para autorizar o microfone e o toggle para alternar entre modo normal e irrestrito. A conversa é contínua após iniciar.</p>

      <div class="row">
        <label class="toggle" title="Alternar modo irrestrito">
          <span>Normal</span>
          <input id="modeToggle" type="checkbox" />
          <span>Irrestrito</span>
        </label>
        <button id="startBtn" class="btn">Iniciar conversa</button>
        <span id="status" class="status"></span>
      </div>

      <div id="log" class="widget-wrap"></div>
    </main>

    <script type="module">
      // Carrega o SDK da Vapi priorizando UMD (mais compatível), com fallbacks
      let VapiCtor = null;
      async function loadVapi() {
        if (VapiCtor) return VapiCtor;
        // 1) Tenta UMD por diferentes CDNs
        const umdUrls = [
          'https://cdn.jsdelivr.net/npm/@vapi-ai/web/dist/index.umd.js',
          'https://cdn.jsdelivr.net/npm/@vapi-ai/web',
          'https://unpkg.com/@vapi-ai/web@latest/dist/index.umd.js'
        ];
        for (const url of umdUrls) {
          try {
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = url;
              s.async = true;
              s.defer = true;
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
            const candidate = (window.Vapi && (window.Vapi.default || window.Vapi)) || window.VapiWeb || window.VapiAI || window.vapi;
            if (typeof candidate === 'function') {
              VapiCtor = candidate;
              return VapiCtor;
            }
          } catch {}
        }
        // 2) Fallback ESM
        const esmUrls = [
          'https://cdn.jsdelivr.net/npm/@vapi-ai/web/+esm',
          'https://esm.sh/@vapi-ai/web',
          'https://cdn.skypack.dev/@vapi-ai/web'
        ];
        for (const url of esmUrls) {
          try {
            const mod = await import(url);
            const candidate = mod?.default ?? mod?.Vapi ?? mod?.VapiWeb ?? mod;
            if (typeof candidate === 'function') {
              VapiCtor = candidate;
              return VapiCtor;
            }
          } catch {}
        }
        throw new Error('Não foi possível carregar o SDK da Vapi a partir das CDNs conhecidas.');
      }

      const NORMAL_ASSISTANT_ID = 'b7146a9e-bae1-4245-87f7-e72b1335ac55';
      const UNRESTRICTED_ASSISTANT_ID = 'aa7f1b14-8dbc-4a59-9f5e-16079eae4da7';
      const PUBLIC_KEY = '13eed109-a96b-434f-90b6-60d81c28663d';

      const startBtn = document.getElementById('startBtn');
      const modeToggle = document.getElementById('modeToggle');
      const statusEl = document.getElementById('status');
      const logEl = document.getElementById('log');

      // Improve transcript container scrolling
      logEl.style.overflow = 'auto';
      logEl.style.maxHeight = '240px';

      function setStatus(text) { statusEl.textContent = text; }
      function appendLog(text) {
        const item = document.createElement('div');
        item.textContent = text;
        item.style.fontSize = '12px';
        item.style.opacity = '0.9';
        logEl.appendChild(item);
        logEl.scrollTop = logEl.scrollHeight;
      }

      async function ensureMicPermission() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          stream.getTracks().forEach(track => track.stop());
          return true;
        } catch (err) {
          console.error('Mic permission error:', err);
          return false;
        }
      }

      let vapi = null;
      async function ensureVapi() {
        if (vapi) return vapi;
        const VapiClass = await loadVapi();
        vapi = new VapiClass(PUBLIC_KEY);
        vapi.on('call-start', () => {
          setStatus('Chamada iniciada. Fale com a Delfos.');
        });
        vapi.on('call-end', () => {
          setStatus('Chamada encerrada.');
        });
        vapi.on('message', (message) => {
          if (message && message.type === 'transcript' && message.transcript) {
            appendLog(`${message.role}: ${message.transcript}`);
          }
        });
        vapi.on('error', (err) => {
          appendLog(`erro: ${err?.message || String(err)}`);
          setStatus('Erro na chamada.');
        });
        return vapi;
      }

      function getAssistantId() {
        return modeToggle.checked ? UNRESTRICTED_ASSISTANT_ID : NORMAL_ASSISTANT_ID;
      }

      async function startConversation() {
        setStatus('Solicitando acesso ao microfone...');
        const granted = await ensureMicPermission();
        if (!granted) {
          setStatus('Permissão do microfone negada. Autorize para continuar.');
          return;
        }
        setStatus('Carregando Vapi...');
        try {
          await ensureVapi();
        } catch (e) {
          console.error(e);
          setStatus('Falha ao carregar o SDK da Vapi.');
          return;
        }
        setStatus('Conectando...');
        logEl.innerHTML = '';
        try {
          startBtn.disabled = true;
          await vapi.start(getAssistantId());
          // Beep curto para indicar pronto
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = 880; gain.gain.value = 0.02;
            osc.connect(gain).connect(ctx.destination);
            osc.start(); setTimeout(() => { osc.stop(); ctx.close(); }, 120);
          } catch {}
        } catch (err) {
          console.error(err);
          setStatus('Falha ao iniciar a chamada.');
        } finally {
          startBtn.disabled = false;
        }
      }

      modeToggle.addEventListener('change', () => {
        setStatus(modeToggle.checked ? 'Modo: Irrestrito' : 'Modo: Normal');
      });

      startBtn.addEventListener('click', startConversation);

      // Estado inicial
      setStatus('Modo: Normal');
    </script>
  </body>
  </html>

