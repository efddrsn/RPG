<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Speech-to-Speech Delphos AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #0ff;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #0ff;
            border-radius: 5px;
        }
        
        button {
            background: #222;
            color: #0ff;
            border: 1px solid #0ff;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #0ff;
            color: #000;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #0ff;
        }
        
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #000;
            border: 1px solid #444;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        
        .log-error { color: #ff4444; }
        .log-success { color: #44ff44; }
        .log-info { color: #ffff44; }
        .log-debug { color: #8888ff; }
        
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #222;
            border: 1px solid #0ff;
            color: #0ff;
            font-family: monospace;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .indicator.active { background: #0f0; }
        .indicator.inactive { background: #f00; }
        .indicator.warning { background: #ff0; }
    </style>
</head>
<body>
    <h1>🎤 Teste do Sistema Speech-to-Speech</h1>
    
    <div class="test-section">
        <h2>1. Configuração das APIs</h2>
        <label>
            OpenAI API Key:
            <input type="password" id="openaiKey" placeholder="sk-...">
        </label>
        <label>
            Eleven Labs API Key (opcional):
            <input type="password" id="elevenLabsKey" placeholder="Eleven Labs API Key">
        </label>
        <button onclick="saveApiKeys()">Salvar API Keys</button>
        <button onclick="validateKeys()">Validar Conexões</button>
    </div>
    
    <div class="test-section">
        <h2>2. Sistema de Voz</h2>
        <button onclick="initSystem()">Inicializar Sistema</button>
        <button onclick="testMicrophone()">Testar Microfone</button>
        <button onclick="testTTSNative()">Testar TTS Nativo</button>
        <button onclick="testTTSElevenLabs()">Testar TTS Eleven Labs</button>
        <button onclick="getSystemStatus()">Status do Sistema</button>
    </div>
    
    <div class="test-section">
        <h2>3. Teste Speech-to-Speech Completo</h2>
        <button id="stsBtn" onclick="toggleSTS()">🎤 Iniciar Speech-to-Speech</button>
        <button onclick="testFullCycle()">Testar Ciclo Completo</button>
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="autoMode"> Modo Conversacional Contínuo
            </label>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. Teste Manual</h2>
        <textarea id="manualText" placeholder="Digite texto para testar TTS...">Olá! Este é um teste do sistema de voz da Delphos AI. Como posso ajudar você hoje?</textarea>
        <button onclick="testManualTTS()">Falar Texto</button>
        <button onclick="testManualTTSDemonic()">Falar (Modo Demoníaco)</button>
    </div>
    
    <div class="status">
        <h3>Status:</h3>
        <div>Sistema de Voz: <span id="voiceStatus">Não inicializado</span><span id="voiceIndicator" class="indicator inactive"></span></div>
        <div>Microfone: <span id="micStatus">Não testado</span><span id="micIndicator" class="indicator inactive"></span></div>
        <div>TTS: <span id="ttsStatus">Não testado</span><span id="ttsIndicator" class="indicator inactive"></span></div>
        <div>OpenAI: <span id="openaiStatus">Não configurado</span><span id="openaiIndicator" class="indicator inactive"></span></div>
        <div>Eleven Labs: <span id="elevenLabsStatus">Não configurado</span><span id="elevenLabsIndicator" class="indicator inactive"></span></div>
    </div>
    
    <div class="log" id="log">
        <div class="log-entry log-info">Sistema de teste iniciado...</div>
    </div>
    
    <script src="elevenlabs-tts.js"></script>
    <script src="elevenlabs-enhanced.js"></script>
    <script src="voice-system.js"></script>
    
    <script>
        let voiceSystem = null;
        let isSTS = false;
        let apiKeys = {
            openai: localStorage.getItem('openai_api_key') || '',
            elevenLabs: localStorage.getItem('elevenlabs_api_key') || ''
        };
        
        // Carregar API keys salvas
        if (apiKeys.openai) document.getElementById('openaiKey').value = apiKeys.openai;
        if (apiKeys.elevenLabs) document.getElementById('elevenLabsKey').value = apiKeys.elevenLabs;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(element, status, indicatorClass) {
            document.getElementById(element).textContent = status;
            const indicator = document.getElementById(element.replace('Status', 'Indicator'));
            if (indicator) {
                indicator.className = 'indicator ' + indicatorClass;
            }
        }
        
        function saveApiKeys() {
            apiKeys.openai = document.getElementById('openaiKey').value;
            apiKeys.elevenLabs = document.getElementById('elevenLabsKey').value;
            
            localStorage.setItem('openai_api_key', apiKeys.openai);
            localStorage.setItem('elevenlabs_api_key', apiKeys.elevenLabs);
            
            log('API Keys salvas no localStorage', 'success');
            
            if (voiceSystem && apiKeys.elevenLabs) {
                voiceSystem.setElevenLabsApiKey(apiKeys.elevenLabs);
                log('Eleven Labs API Key configurada no sistema de voz', 'info');
            }
        }
        
        async function validateKeys() {
            // Validar OpenAI
            if (apiKeys.openai) {
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${apiKeys.openai}`
                        }
                    });
                    
                    if (response.ok) {
                        updateStatus('openaiStatus', 'Conectado', 'active');
                        log('OpenAI API validada com sucesso', 'success');
                    } else {
                        updateStatus('openaiStatus', 'Erro na API Key', 'inactive');
                        log(`OpenAI API erro: ${response.status}`, 'error');
                    }
                } catch (error) {
                    updateStatus('openaiStatus', 'Erro de conexão', 'inactive');
                    log(`OpenAI erro: ${error.message}`, 'error');
                }
            }
            
            // Validar Eleven Labs
            if (voiceSystem && apiKeys.elevenLabs) {
                try {
                    const validation = await voiceSystem.validateElevenLabsConnection();
                    if (validation && validation.valid) {
                        updateStatus('elevenLabsStatus', 'Conectado', 'active');
                        log('Eleven Labs API validada com sucesso', 'success');
                    } else {
                        updateStatus('elevenLabsStatus', 'API Key inválida', 'inactive');
                        log('Eleven Labs API Key inválida', 'error');
                    }
                } catch (error) {
                    updateStatus('elevenLabsStatus', 'Erro de conexão', 'inactive');
                    log(`Eleven Labs erro: ${error.message}`, 'error');
                }
            }
        }
        
        function initSystem() {
            try {
                log('Inicializando sistema de voz...', 'info');
                voiceSystem = new DelphosVoiceSystem();
                
                if (apiKeys.elevenLabs) {
                    voiceSystem.setElevenLabsApiKey(apiKeys.elevenLabs);
                }
                
                updateStatus('voiceStatus', 'Inicializado', 'active');
                log('Sistema de voz inicializado com sucesso', 'success');
                
                // Obter status inicial
                setTimeout(() => getSystemStatus(), 1000);
            } catch (error) {
                updateStatus('voiceStatus', 'Erro na inicialização', 'inactive');
                log(`Erro ao inicializar: ${error.message}`, 'error');
            }
        }
        
        async function testMicrophone() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            try {
                log('Solicitando permissão do microfone...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                updateStatus('micStatus', 'Funcionando', 'active');
                log('Microfone autorizado e funcionando', 'success');
                
                // Testar reconhecimento de voz
                log('Iniciando teste de reconhecimento de voz (5 segundos)...', 'info');
                voiceSystem.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    log(`Reconhecido: "${transcript}"`, 'success');
                };
                
                voiceSystem.startListening();
                
                setTimeout(() => {
                    voiceSystem.stopListening();
                    log('Teste de reconhecimento concluído', 'info');
                }, 5000);
                
            } catch (error) {
                updateStatus('micStatus', 'Erro/Negado', 'inactive');
                log(`Erro no microfone: ${error.message}`, 'error');
            }
        }
        
        async function testTTSNative() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            try {
                log('Testando TTS nativo...', 'info');
                voiceSystem.setTTSMode('native');
                
                await voiceSystem.speak('Teste do sistema de síntese de voz nativo. Um, dois, três, testando!');
                
                updateStatus('ttsStatus', 'TTS Nativo OK', 'active');
                log('TTS nativo funcionando', 'success');
            } catch (error) {
                updateStatus('ttsStatus', 'Erro TTS Nativo', 'inactive');
                log(`Erro TTS nativo: ${error.message}`, 'error');
            }
        }
        
        async function testTTSElevenLabs() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            if (!apiKeys.elevenLabs) {
                log('Configure a API Key do Eleven Labs primeiro!', 'error');
                return;
            }
            
            try {
                log('Testando TTS Eleven Labs...', 'info');
                voiceSystem.setTTSMode('elevenlabs');
                
                await voiceSystem.speak('Teste do sistema Eleven Labs. Esta é uma voz mais natural e expressiva!');
                
                updateStatus('ttsStatus', 'Eleven Labs OK', 'active');
                log('TTS Eleven Labs funcionando', 'success');
            } catch (error) {
                updateStatus('ttsStatus', 'Erro Eleven Labs', 'inactive');
                log(`Erro TTS Eleven Labs: ${error.message}`, 'error');
                
                // Voltar para nativo em caso de erro
                voiceSystem.setTTSMode('native');
                log('Voltando para TTS nativo', 'info');
            }
        }
        
        function getSystemStatus() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            const status = voiceSystem.getStatus();
            log('Status do sistema:', 'debug');
            log(`- Modo TTS: ${status.ttsMode}`, 'debug');
            log(`- Eleven Labs configurado: ${status.elevenLabsConfigured}`, 'debug');
            log(`- TTS nativo disponível: ${status.nativeTTSAvailable}`, 'debug');
            log(`- Reconhecimento disponível: ${status.speechRecognitionAvailable}`, 'debug');
            log(`- Vozes carregadas: ${status.voicesLoaded}`, 'debug');
            log(`- Ouvindo: ${status.isListening}`, 'debug');
            log(`- Falando: ${status.isSpeaking}`, 'debug');
        }
        
        async function testManualTTS() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            const text = document.getElementById('manualText').value;
            if (!text) {
                log('Digite algum texto primeiro!', 'error');
                return;
            }
            
            try {
                log(`Falando: "${text}"`, 'info');
                await voiceSystem.speak(text, false);
                log('Fala concluída', 'success');
            } catch (error) {
                log(`Erro ao falar: ${error.message}`, 'error');
            }
        }
        
        async function testManualTTSDemonic() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            const text = document.getElementById('manualText').value;
            if (!text) {
                log('Digite algum texto primeiro!', 'error');
                return;
            }
            
            try {
                log(`Falando (modo demoníaco): "${text}"`, 'info');
                await voiceSystem.speak(text, true);
                log('Fala demoníaca concluída', 'success');
            } catch (error) {
                log(`Erro ao falar: ${error.message}`, 'error');
            }
        }
        
        function toggleSTS() {
            if (!voiceSystem) {
                log('Sistema não inicializado!', 'error');
                return;
            }
            
            isSTS = !isSTS;
            const btn = document.getElementById('stsBtn');
            
            if (isSTS) {
                btn.textContent = '⏹️ Parar Speech-to-Speech';
                btn.style.background = '#ff0';
                btn.style.color = '#000';
                
                if (document.getElementById('autoMode').checked) {
                    voiceSystem.autoListen = true;
                    log('Modo conversacional contínuo ativado', 'info');
                }
                
                startSTS();
            } else {
                btn.textContent = '🎤 Iniciar Speech-to-Speech';
                btn.style.background = '#222';
                btn.style.color = '#0ff';
                
                voiceSystem.autoListen = false;
                voiceSystem.stopListening();
                voiceSystem.stopSpeaking();
                
                log('Speech-to-Speech parado', 'info');
            }
        }
        
        async function startSTS() {
            log('Iniciando Speech-to-Speech...', 'info');
            
            // Configurar handlers
            voiceSystem.handleVoiceInput = async (transcript) => {
                log(`Você disse: "${transcript}"`, 'info');
                
                // Obter resposta da AI
                try {
                    const response = await getAIResponse(transcript);
                    log(`Delphos responde: "${response}"`, 'success');
                    
                    // Falar resposta
                    await voiceSystem.speak(response, false);
                    
                } catch (error) {
                    log(`Erro ao obter resposta: ${error.message}`, 'error');
                }
            };
            
            // Iniciar escuta
            voiceSystem.startListening();
        }
        
        async function getAIResponse(message) {
            if (!apiKeys.openai) {
                throw new Error('Configure a API Key do OpenAI primeiro!');
            }
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKeys.openai}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        { 
                            role: 'system', 
                            content: 'Você é a Delphos AI, um sistema de previsões estratégicas. Responda de forma breve e misteriosa em português brasileiro.' 
                        },
                        { role: 'user', content: message }
                    ],
                    temperature: 0.8,
                    max_tokens: 100
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function testFullCycle() {
            log('=== INICIANDO TESTE COMPLETO ===', 'info');
            
            // 1. Inicializar
            if (!voiceSystem) {
                initSystem();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // 2. Validar APIs
            await validateKeys();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 3. Testar microfone
            await testMicrophone();
            await new Promise(resolve => setTimeout(resolve, 6000));
            
            // 4. Testar TTS nativo
            await testTTSNative();
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 5. Testar TTS Eleven Labs (se configurado)
            if (apiKeys.elevenLabs) {
                await testTTSElevenLabs();
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
            
            // 6. Status final
            getSystemStatus();
            
            log('=== TESTE COMPLETO FINALIZADO ===', 'success');
        }
        
        // Inicializar automaticamente se já tiver as keys
        window.addEventListener('load', () => {
            if (apiKeys.openai || apiKeys.elevenLabs) {
                log('API Keys detectadas, inicializando sistema...', 'info');
                setTimeout(() => initSystem(), 500);
            }
        });
    </script>
</body>
</html>